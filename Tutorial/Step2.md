# Topic XX 3D都市モデルを使った位置情報共有ゲームを作る

近年位置情報を基盤としたサービスが多く使われています。Google MapsやUberなどはその典型でしょう。
自分の位置情報をスマートフォン端末のGPSで取得し、サービスのサーバーに送信することで、さまざまな便利なサービスを受けることができます。
本トピックでは、このような位置情報をオンラインでやり取りしたり、サーバーで処理してサービスを提供するなどに向けたPLATEAUの3D都市モデルの活用を位置情報ゲームを作りながら説明します。

## まずは基本のゲームを作る

本トピックではスマートフォンAR位置情報ゲームを作ります。
ゲームは、最初にプレイヤーが赤と白の色を選び、自分が属する陣営を決めます。
AR画面になると、端末カメラが映す実際の街並みが表示されます。
PLATEAUの3D都市モデルを使い、タップするとその場所の建物に「ペンキ」が塗られ、町中の色々なところを塗って最初の点までつないで閉じると、
そこが自陣営の陣地になります。ゲームはとった陣地の面積を競います。

サーバーサイドにはPostGIS拡張をインストールしたPostgreSQLデータベースを使います。
面積は、ゲームプレイ時はとった陣地の合計をサーバーで計算しますが、
ゲーム終了後にバッチで重ね合わせを考慮した結果の面積を計算する仕様にします。
これは、時間順に重ね合わせて面積を計算する処理が、リアルタイムに計算にするには重いためです。

### ARの設定をする



### PLATEAUを読み込む


### Paint in 3Dを導入し、PLATEAUにペンキを塗れるようにする

PLATEAUモデルの準備
UV1の設定
マテリアル
Decalで塗るのを作成


### 塗った場所の位置座標を計算する

GeospatialでWorld座標から緯度経度にする

## サーバーに位置情報を送る

位置情報を送る先のサーバーを作ります。
機能としては、HTTPでJSONにした位置情報をクライアントとやり取りするシンプルなAPIサーバーです。
サーバーでは位置情報を受信すると、それをPostGISの空間情報データとしてデータベースに格納し、
空間クエリで面積を計算してクライアントに結果を返します。

サーバーにはさまざまな技術がありますが、
ここではフレームワークにはPythonのFlaskを使い、PostgreSQL+PostGISをバックエンドデータベースとして使います。
また、動作させるインフラとして、AWSを使うこととします。

これらの構成はあくまでもこのサンプルでの説明用で、同じようなことをやる場合のさまざまな選択肢があります。
今回はなるべく汎用的かつ基本的で、読者が自分の環境に読み替えて考えやすい作り方を目指しました。
言語もフレームワークもクラウドもデータベースも多くの選択肢があるので、自分の慣れているものに読み替えてください。

また、HTTPでやり取りするAPIは、リアルタイムでの同期には向いていません。
FirebaseなどのMBaaSや、Photonなどのリアルタイム通信基盤など、まったく別の考え方の選択肢もあります。
ここでは詳細を説明しませんが、作りたいサービスに合わせて選択してください。

### サーバーのプログラムを作る
Python・Flaskで作るかな
送信可能なAPIをまず作る
デプロイ先はAWSにしよう
スキーマの決定

早速サーバーのプログラムを開発していきます。



### サーバーへの位置情報の送信
UnityWebRequest
APIに合わせてリクエスト
ループを閉じたときにまとめてリクエスト
DBに、ID（AutoInc）、時刻、ユーザーのUUID、Geomを格納


### サーバーでの面積の計算
PostGISのクエリでSQLで計算してみる
SELECT　でArea計算

### サーバーで塗った場所の表示
これはQGISで直接DBにアクセスしてやろうかな
それが一番楽そう

### 正確な面積計算のプログラム
データ分析の文脈でこの辺をQGIS？あたりを使いながら説明

### コラム　チート対策

### コラム　プライバシーについて

## アプリとしてリリースする

AppStore・Google Playに出す方法


//////　以下メモ

## 位置情報を複数人で共有する

サーバーと連携する仕組みの作成
 位置情報を扱うときに気にすること
  座標系
  精度
 データベース
  格納方法 単なるDoubleか、空間データ構造か
  インデックス

## 池袋塗りつぶしゲームを作る

  チート対策
 データ分析
  どんな分析ができる？
  分析のヒント
 オクルージョン

## アプリとしてリリースする

AppStore・Google Playに出す方法
